name: VPS Ubuntu 22.04 VM + Bot (Persistent + Auto-Restart)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # auto restart tiap 6 jam

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
    - name: Restore Disk State
      uses: actions/download-artifact@v4
      with:
        name: ubuntu-disk
        path: .
      continue-on-error: true

    - name: Install QEMU & Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-kvm qemu-utils cloud-image-utils wget curl tmate unzip tar docker.io docker-compose nodejs npm ufw

    - name: Download Ubuntu Cloud Image
      run: |
        IMG=ubuntu-22.04.img
        URL=https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img
        if [ ! -f "$IMG" ]; then
          wget -c --tries=20 --timeout=30 --show-progress $URL -O $IMG
        fi
        qemu-img resize $IMG 32G || true

    - name: Create Cloud-init Config (bot user + auto-restart)
      run: |
        cat > user-data <<EOF
        #cloud-config
        users:
          - name: luxzz
            sudo: ALL=(ALL) NOPASSWD:ALL
            groups: sudo
            shell: /bin/bash
            lock_passwd: false
            plain_text_passwd: "luxzz"
        password: luxzz
        chpasswd: { expire: False }
        ssh_pwauth: True
        package_update: true
        package_upgrade: true
        packages:
          - curl wget unzip tar sudo gnupg software-properties-common apt-transport-https ca-certificates lsb-release
          - nodejs npm docker.io docker-compose ufw
        runcmd:
          - systemctl enable docker
          - systemctl start docker
          - ufw allow 22
          - ufw --force enable
          # auto trigger restart ke GitHub setelah 6 jam
          - bash -c "(sleep 21600 && curl -X POST -H 'Accept: application/vnd.github+json' -H 'Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}' https://api.github.com/repos/${{ github.repository }}/actions/workflows/vps.yml/dispatches -d '{\"ref\":\"main\"}') &"
        EOF
        echo "instance-id: iid-local01" > meta-data
        cloud-localds seed.img user-data meta-data

    - name: Start VM with QEMU
      run: |
        nohup qemu-system-x86_64 \
          -m 8192 \
          -smp 2 \
          -drive file=ubuntu-22.04.img,if=virtio \
          -drive file=seed.img,if=virtio \
          -net nic -net user,hostfwd=tcp::2222-:22 \
          -nographic > vm.log 2>&1 &

    - name: Wait for Boot
      run: sleep 180

    - name: Start SSH Session (tmate)
      uses: mxschmitt/action-tmate@v3
      with:
        limit-access-to-actor: false

    - name: Save Disk State
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ubuntu-disk
        path: ubuntu-22.04.img
